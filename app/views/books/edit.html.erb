<%= div_with_data_for @book do %>
  <%= content_tag :header do %>
    <%= @book.title %>
  <% end %>
  <% edition = @book.editions.last %>
  <%= div_with_data_for edition do %>
    <%= content_tag :header do %>
      version <%= edition.version %>
    <% end %>
    <% if edition.release.blank? %>
      <%= link_to 'release!', release_edition_path(edition), :method => :put %>
    <% end %>
    <% @book.table_of_contents.in_edition(edition).chapterish.order(:ordering).map(&:chapter).each do |chapter| %>
      <%= div_with_data_for chapter, :class => 'read_by_chapter' do %>
        <%= content_tag :header, :class => 'chapter_title' do %>
          <%= chapter.title %>
        <% end %>
        <%= content_tag :header, :class => 'chapter_subtitle' do %>
          <%= chapter.subtitle %>
        <% end %>
        <% @book.table_of_contents.in_edition(edition).in_chapter(chapter).sectionish.order(:ordering).map(&:section).each do |section| %>
          <%= div_with_data_for section do %>
            <%= content_tag :header, :class => 'section_heading' do %>
              <%= section.heading %>
            <% end %>
            <%= content_tag :header, :class => 'section_subheading' do %>
              <%= section.subheading %>
            <% end %>
            <% @book.table_of_contents.in_edition(edition).in_chapter(chapter).in_section(section).paragraphish.order(:ordering).map(&:paragraph).each do |paragraph| %>
              <%= div_with_data_for paragraph do %>
                <%= mark_up paragraph.text %>
                <%= focus_append_on paragraph %>
                <%= link_to 'edit', edit_paragraph_path(paragraph, :book_id => @book.id, :edition_id => edition.id, :chapter_id => chapter.id, :section_id => section.id, :format => :js), :remote => true %>
                <%= link_to 'remove', paragraph_path(paragraph, :book_id => @book.id, :edition_id => edition.id, :chapter_id => chapter.id, :section_id => section.id, :format => :js), :method => :delete, :remote => true %>
                <% @book.table_of_contents.in_edition(edition).in_chapter(chapter).in_section(section).in_paragraph(paragraph).citationish.order(:ordering).map(&:citation).each do |citation| %>
                  <%= div_with_data_for citation do %>
                    <%= citation.finding %>
                    <%= citation.source %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <%= focus_append_on section %>
          <% end %>
        <% end %>
        <%= focus_append_on chapter %>
      <% end %>
    <% end %>
    <%= focus_append_on edition %>
  <% end %>
  <% if @book.editions.empty? %>
    <%= link_to 'Begin first edition', new_edition_path(:book_id => @book.id) %>
  <% end %>
<% end %>

<%= render 'form', :book => @book %>
