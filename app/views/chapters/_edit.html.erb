<%= div_with_data_for chapter, :class => 'read_by_chapter' do %>
  <%= content_tag :header, :class => 'chapter_title' do %>
    <%= chapter.title %>
  <% end %>
  <%= div_for @chapter, :subtitle_of do %>
    <%= content_tag :header, :class => 'chapter_subtitle' do %>
      <%= chapter.subtitle %>
    <% end %>
  <% end %>
  <% book.table_of_contents.in_edition(edition).in_chapter(chapter).sectionish.order(:ordering).each do |section_table_of_content| %>
    <% section = section_table_of_content.section %>
    <%= div_with_data_for section do %>
      <%= div_for section, :data_on do %>
        <%= content_tag :header, :class => 'section_heading' do %>
          <%= section.heading %>
        <% end %>
        <%= content_tag :header, :class => 'section_subheading' do %>
          <%= section.subheading %>
        <% end %>
      <% end %>
      <%= div_for section, :controls_for, :class => 'controls' do %>
        <%= link_to 'promote', promote_section_path(section, :book_id => book.id, :edition_id => edition.id, :chapter_id => chapter.id, :format => :js), :method => :put, :remote => true, :title => "put before previous section (at #{section_table_of_content.ordering})" if TableOfContent.sectionish.where(:edition => edition, :chapter => chapter, :ordering => section_table_of_content.ordering - 1).present? %>
        <%= link_to 'edit', edit_section_path(section, :book_id => book.id, :edition_id => edition.id, :chapter_id => chapter.id, :format => :js), :remote => true %>
        <%= link_to 'remove', section_path(section, :book_id => book.id, :edition_id => edition.id, :chapter_id => chapter.id, :format => :js), :method => :delete, :remote => true %>
      <% end %>
      <% book.table_of_contents.in_edition(edition).in_chapter(chapter).in_section(section).paragraphish.order(:ordering).each do |paragraph_table_of_content| %>
        <% paragraph = paragraph_table_of_content.paragraph %>
        <%= div_with_data_for paragraph do %>
          <%= mark_up paragraph.text %>
          
          <%= div_for paragraph, :controls_for, :class => 'controls' do %>
            <%= focus_append_on paragraph %>
            <%= link_to 'delay', delay_paragraph_path(paragraph, :table_of_content_id => paragraph_table_of_content, :format => :js), :method => :put, :remote => true, :title => 'move to next section' if section_table_of_content.succeeding.present? %>
            <%= link_to 'promote', promote_paragraph_path(paragraph, :table_of_content_id => paragraph_table_of_content, :format => :js), :method => :put, :remote => true, :title => "put before previous paragraph (at #{paragraph_table_of_content.ordering})" if TableOfContent.paragraphish.where(:edition => edition, :chapter => chapter, :section => section, :ordering => paragraph_table_of_content.ordering - 1).present? %>
            <%= link_to 'edit', edit_paragraph_path(paragraph, :table_of_content_id => paragraph_table_of_content, :format => :js), :remote => true %>
            <%= link_to 'remove', paragraph_path(paragraph, :table_of_content_id => paragraph_table_of_content, :format => :js), :method => :delete, :remote => true %>
          <% end %>
          
          <% book.table_of_contents.in_edition(edition).in_chapter(chapter).in_section(section).in_paragraph(paragraph).citationish.order(:ordering).map(&:citation).each do |citation| %>
            <%= div_with_data_for citation do %>
              <%= div_for citation, :finding_of do %>
                <%= citation.finding %>
              <% end %>
              <%= link_to 'hide', "javascript: $('##{dom_id(citation)}').hide()", :class => 'citation_hider' %>
              <%= div_for citation, :source_of do %>
                <%= citation.source %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
      <%= append_to section_table_of_content %>
    <% end %>
  <% end %>
  <%= focus_append_on chapter %>
<% end %>
